<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>Neural Nets with Keras - Part 1 : Time series - MacGRython</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://tboquet.github.io/neural-nets-with-keras-part-1-time-series.html">

        <meta name="author" content="Thomas Boquet" />
        <meta name="keywords" content="python,keras" />
        <meta name="description" content="Simple neural nets with keras" />

        <meta property="og:site_name" content="MacGRython" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Neural Nets with Keras - Part 1 : Time series"/>
        <meta property="og:url" content="http://tboquet.github.io/neural-nets-with-keras-part-1-time-series.html"/>
        <meta property="og:description" content="Simple neural nets with keras"/>
        <meta property="article:published_time" content="2015-11-24" />
            <meta property="article:section" content="Tutorials" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="keras" />
            <meta property="article:author" content="Thomas Boquet" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://tboquet.github.io/theme/css/bootstrap.cosmo.min.css" type="text/css"/>
    <link href="http://tboquet.github.io/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://tboquet.github.io/theme/css/pygments/monokai.css" rel="stylesheet">
    <link rel="stylesheet" href="http://tboquet.github.io/theme/css/style.css" type="text/css"/>

        <link href="http://tboquet.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="MacGRython ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://tboquet.github.io/" class="navbar-brand">
<img src="http://tboquet.github.io/images/transwhite.png" width="24"/> MacGRython            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="http://tboquet.github.io/category/about.html">About</a>
                        </li>
                        <li >
                            <a href="http://tboquet.github.io/category/misc.html">Misc</a>
                        </li>
                        <li class="active">
                            <a href="http://tboquet.github.io/category/tutorials.html">Tutorials</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="http://tboquet.github.io/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://tboquet.github.io/neural-nets-with-keras-part-1-time-series.html"
                       rel="bookmark"
                       title="Permalink to Neural Nets with Keras - Part 1 : Time series">
                        Neural Nets with Keras - Part 1 : Time series
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2015-11-24T11:22:00-05:00"> Tue 24 November 2015</time>
    </span>



<span class="label label-default">Tags</span>
	<a href="http://tboquet.github.io/tag/python.html">python</a>
        /
	<a href="http://tboquet.github.io/tag/keras.html">keras</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <div class="section" id="introduction-and-data-generation">
<h2>Introduction and data generation</h2>
<p>This first part of the tutorial will focus on simple Artificial Neural
Networks.</p>
<p>We will try to predict time series (continuous signals) using simple
architectures.</p>
<p>The notation used are taken from the <a class="reference external" href="https://www.youtube.com/playlist?list=PL6Xpj9I5qXYEcOhn7TqghAJ6NAPrNmUBH">best introduction</a> to neural networks I've found from Hugo Larochelle.</p>
<p>Suppose that we want to study a time series following this process:</p>
<div class="math">
\begin{equation*}
y_t = \sin(\pi\frac{x_t}{800})
\end{equation*}
</div>
<p>We can easily generate this data with numpy:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="pgcsskn">import</span> <span class="pgcssnn">numpy</span> <span class="pgcsskn">as</span> <span class="pgcssnn">np</span>
<span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">random</span><span class="pgcsso">.</span><span class="pgcssn">seed</span><span class="pgcssp">(</span><span class="pgcssmi">1337</span><span class="pgcssp">)</span>


<span class="pgcssn">sample</span> <span class="pgcsso">=</span> <span class="pgcssmi">100000</span>
<span class="pgcssn">Fs</span> <span class="pgcsso">=</span> <span class="pgcssmi">80</span>
<span class="pgcssn">f</span> <span class="pgcsso">=</span> <span class="pgcssmi">5</span>
<span class="pgcssn">time</span> <span class="pgcsso">=</span> <span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">arange</span><span class="pgcssp">(</span><span class="pgcssn">sample</span><span class="pgcssp">)</span>

<span class="pgcssn">y_t</span> <span class="pgcsso">=</span> <span class="pgcssmi">40</span> <span class="pgcsso">+</span> <span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">sin</span><span class="pgcssp">((</span><span class="pgcssmi">2</span> <span class="pgcsso">*</span> <span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">pi</span> <span class="pgcsso">*</span> <span class="pgcssn">f</span> <span class="pgcsso">*</span> <span class="pgcssn">time</span><span class="pgcssp">)</span><span class="pgcsso">/</span> <span class="pgcssn">Fs</span><span class="pgcsso">/</span><span class="pgcssmi">100</span><span class="pgcssp">)</span> <span class="pgcsso">+</span><span class="pgcssmf">1e-5</span><span class="pgcsso">*</span><span class="pgcssn">time</span><span class="pgcsso">+</span><span class="pgcssmf">1e-9</span><span class="pgcsso">*</span><span class="pgcssn">time</span><span class="pgcsso">**</span><span class="pgcssmi">2</span> <span class="pgcsso">+</span> <span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">sin</span><span class="pgcssp">((</span><span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">pi</span> <span class="pgcsso">*</span> <span class="pgcssn">f</span><span class="pgcsso">/</span><span class="pgcssmi">2</span> <span class="pgcsso">*</span> <span class="pgcssn">time</span><span class="pgcssp">)</span> <span class="pgcsso">/</span> <span class="pgcssn">Fs</span> <span class="pgcsso">/</span> <span class="pgcssmi">15</span><span class="pgcssp">)</span>
</pre></div>
</td></tr></table><p>Graphically we have a nice sinusoidal function:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="pgcsskn">import</span> <span class="pgcssnn">matplotlib.pyplot</span> <span class="pgcsskn">as</span> <span class="pgcssnn">plt</span>
<span class="pgcsso">%</span><span class="pgcssn">matplotlib</span> <span class="pgcssn">inline</span>
<span class="pgcssn">fig</span> <span class="pgcsso">=</span> <span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">figure</span><span class="pgcssp">(</span><span class="pgcssn">figsize</span><span class="pgcsso">=</span><span class="pgcssp">(</span><span class="pgcssmi">12</span><span class="pgcssp">,</span><span class="pgcssmi">8</span><span class="pgcssp">))</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">style</span><span class="pgcsso">.</span><span class="pgcssn">use</span><span class="pgcssp">(</span><span class="pgcsss">&#39;ggplot&#39;</span><span class="pgcssp">)</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">plot</span><span class="pgcssp">(</span><span class="pgcssn">y_t</span><span class="pgcssp">[:])</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">show</span><span class="pgcssp">()</span>
</pre></div>
</td></tr></table><img alt="" src="../../images/nnpart1_files/nnpart1_6_0.png" />
<p>Observations :</p>
<ol class="arabic simple">
<li>it's a nonlinear process</li>
<li>it's not stationary because we see big cycles and seasonnality</li>
<li>it's strictly positive</li>
</ol>
<p>Let's try a simple neural net with a single hidden layer on this data.</p>
<p>let <span class="math">\(y_t\)</span> be the value of the signal at time
<span class="math">\(t=1,\dots, 100000\)</span></p>
<p>We define:</p>
<ul class="simple">
<li>the hidden layers pre-activation:</li>
</ul>
<div class="math">
\begin{equation*}
a(t)_i = b_i^{(1)} + W_i^{(1)}t
\end{equation*}
</div>
<ul class="simple">
<li>the hidden layers activation:</li>
</ul>
<div class="math">
\begin{equation*}
h(t)_i = g(a(t)_i)
\end{equation*}
</div>
<ul class="simple">
<li>the output layer activation:</li>
</ul>
<div class="math">
\begin{equation*}
f(t) = o(b^{(2)} + w_i^{(2)}h^{(1)}(t)_i)
\end{equation*}
</div>
<p>Where we want <span class="math">\(f(t)\)</span> as close as possible to <span class="math">\(y_t\)</span></p>
<p>Here we will build a hidden layer with 10 units the hidden layer
activation function <span class="math">\(g()\)</span> is a sigmoid and the output layer
activation function is linear.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span class="pgcsskn">import</span> <span class="pgcssnn">theano</span>
<span class="pgcsskn">import</span> <span class="pgcssnn">keras</span>
<span class="pgcsskn">from</span> <span class="pgcssnn">keras.models</span> <span class="pgcsskn">import</span> <span class="pgcssn">Graph</span>
<span class="pgcsskn">from</span> <span class="pgcssnn">keras.layers.core</span> <span class="pgcsskn">import</span> <span class="pgcssn">Dense</span>
<span class="pgcsskn">from</span> <span class="pgcssnn">keras.optimizers</span> <span class="pgcsskn">import</span> <span class="pgcssn">Adam</span>


<span class="pgcssn">model</span> <span class="pgcsso">=</span> <span class="pgcssn">Graph</span><span class="pgcssp">()</span>
<span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">add_input</span><span class="pgcssp">(</span><span class="pgcssn">name</span><span class="pgcsso">=</span><span class="pgcsss">&#39;exog&#39;</span><span class="pgcssp">,</span> <span class="pgcssn">input_shape</span><span class="pgcsso">=</span><span class="pgcssp">(</span><span class="pgcssmi">1</span><span class="pgcssp">,))</span>
<span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">add_node</span><span class="pgcssp">(</span><span class="pgcssn">Dense</span><span class="pgcssp">(</span><span class="pgcssmi">10</span><span class="pgcssp">,</span> <span class="pgcssn">activation</span><span class="pgcsso">=</span><span class="pgcsss">&quot;sigmoid&quot;</span><span class="pgcssp">),</span> <span class="pgcssn">name</span><span class="pgcsso">=</span><span class="pgcsss">&#39;dense1&#39;</span><span class="pgcssp">,</span> <span class="pgcssnb">input</span><span class="pgcsso">=</span><span class="pgcsss">&#39;exog&#39;</span><span class="pgcssp">)</span>
<span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">add_node</span><span class="pgcssp">(</span><span class="pgcssn">Dense</span><span class="pgcssp">(</span><span class="pgcssmi">1</span><span class="pgcssp">,</span> <span class="pgcssn">activation</span><span class="pgcsso">=</span><span class="pgcsss">&quot;linear&quot;</span><span class="pgcssp">),</span> <span class="pgcssn">name</span><span class="pgcsso">=</span><span class="pgcsss">&#39;last_dense&#39;</span><span class="pgcssp">,</span> <span class="pgcssnb">input</span><span class="pgcsso">=</span><span class="pgcsss">&#39;dense1&#39;</span><span class="pgcssp">)</span>
<span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">add_output</span><span class="pgcssp">(</span><span class="pgcssn">name</span><span class="pgcsso">=</span><span class="pgcsss">&#39;output&#39;</span><span class="pgcssp">,</span> <span class="pgcssnb">input</span><span class="pgcsso">=</span><span class="pgcsss">&#39;last_dense&#39;</span><span class="pgcssp">)</span>
<span class="pgcssn">adam</span> <span class="pgcsso">=</span> <span class="pgcssn">Adam</span><span class="pgcssp">(</span><span class="pgcssn">lr</span><span class="pgcsso">=</span><span class="pgcssmf">1e-2</span><span class="pgcssp">,</span> <span class="pgcssn">beta_1</span><span class="pgcsso">=</span><span class="pgcssmf">0.9</span><span class="pgcssp">,</span> <span class="pgcssn">beta_2</span><span class="pgcsso">=</span><span class="pgcssmf">0.999</span><span class="pgcssp">,</span> <span class="pgcssn">epsilon</span><span class="pgcsso">=</span><span class="pgcssmf">1e-8</span><span class="pgcssp">)</span>

<span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">compile</span><span class="pgcssp">(</span><span class="pgcssn">optimizer</span><span class="pgcsso">=</span><span class="pgcssn">adam</span><span class="pgcssp">,</span> <span class="pgcssn">loss</span><span class="pgcsso">=</span><span class="pgcssp">{</span><span class="pgcsss">&#39;output&#39;</span><span class="pgcssp">:</span><span class="pgcsss">&#39;mse&#39;</span><span class="pgcssp">})</span>
</pre></div>
</td></tr></table><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="pgcsskn">from</span> <span class="pgcssnn">IPython.display</span> <span class="pgcsskn">import</span> <span class="pgcssn">SVG</span>
<span class="pgcsskn">from</span> <span class="pgcssnn">keras.utils.visualize_util</span> <span class="pgcsskn">import</span> <span class="pgcssn">to_graph</span>

<span class="pgcssn">SVG</span><span class="pgcssp">(</span><span class="pgcssn">to_graph</span><span class="pgcssp">(</span><span class="pgcssn">model</span><span class="pgcssp">)</span><span class="pgcsso">.</span><span class="pgcssn">create</span><span class="pgcssp">(</span><span class="pgcssn">prog</span><span class="pgcsso">=</span><span class="pgcsss">&#39;dot&#39;</span><span class="pgcssp">,</span> <span class="pgcssn">format</span><span class="pgcsso">=</span><span class="pgcsss">&#39;svg&#39;</span><span class="pgcssp">))</span>
</pre></div>
</td></tr></table><object data="../../images/nnpart1_files/nnpart1_10_0.svg" type="image/svg+xml">
</object>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="pgcssk">print</span><span class="pgcssp">([</span><span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">prod</span><span class="pgcssp">(</span><span class="pgcssn">p</span><span class="pgcsso">.</span><span class="pgcssn">shape</span><span class="pgcsso">.</span><span class="pgcssn">eval</span><span class="pgcssp">())</span> <span class="pgcssk">for</span> <span class="pgcssn">p</span> <span class="pgcssow">in</span> <span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">params</span><span class="pgcssp">])</span>
<span class="pgcssk">print</span><span class="pgcssp">(</span><span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">count_params</span><span class="pgcssp">())</span>
</pre></div>
</td></tr></table><pre class="literal-block">
&lt;CudaNdarrayType(float32, matrix)&gt;
[10, 10, 10, 1]
31
</pre>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="pgcssn">time</span> <span class="pgcsso">=</span> <span class="pgcssp">(</span><span class="pgcssn">time</span> <span class="pgcsso">-</span> <span class="pgcssn">time</span><span class="pgcsso">.</span><span class="pgcssn">mean</span><span class="pgcssp">())</span><span class="pgcsso">/</span><span class="pgcssn">time</span><span class="pgcsso">.</span><span class="pgcssn">std</span><span class="pgcssp">()</span>
<span class="pgcssn">history</span> <span class="pgcsso">=</span> <span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">fit</span><span class="pgcssp">({</span><span class="pgcsss">&#39;exog&#39;</span><span class="pgcssp">:</span> <span class="pgcssn">time</span><span class="pgcssp">[:</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">,</span><span class="pgcssbp">None</span><span class="pgcssp">],</span> <span class="pgcsss">&#39;output&#39;</span><span class="pgcssp">:</span> <span class="pgcssn">y_t</span><span class="pgcssp">[:</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">]},</span>
          <span class="pgcssn">validation_data</span><span class="pgcsso">=</span><span class="pgcssp">{</span><span class="pgcsss">&#39;exog&#39;</span><span class="pgcssp">:</span><span class="pgcssn">time</span><span class="pgcssp">[</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">:,</span> <span class="pgcssbp">None</span><span class="pgcssp">],</span> <span class="pgcsss">&#39;output&#39;</span><span class="pgcssp">:</span> <span class="pgcssn">y_t</span><span class="pgcssp">[</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">:]},</span>
          <span class="pgcssn">batch_size</span><span class="pgcsso">=</span><span class="pgcssmi">32</span><span class="pgcssp">,</span>
          <span class="pgcssn">nb_epoch</span><span class="pgcsso">=</span><span class="pgcssmi">15</span><span class="pgcssp">)</span>
</pre></div>
</td></tr></table><pre class="literal-block">
Train on 70000 samples, validate on 30000 samples
Epoch 1/15
70000/70000 [==============================] - 2s - loss: 135.5583 - val_loss: 21.2578
Epoch 2/15
70000/70000 [==============================] - 2s - loss: 1.5000 - val_loss: 17.2053
Epoch 3/15
70000/70000 [==============================] - 2s - loss: 1.0667 - val_loss: 7.6860
Epoch 4/15
70000/70000 [==============================] - 2s - loss: 1.0218 - val_loss: 7.3328
Epoch 5/15
70000/70000 [==============================] - 2s - loss: 1.0213 - val_loss: 6.7753
Epoch 6/15
70000/70000 [==============================] - 2s - loss: 1.0226 - val_loss: 6.0602
Epoch 7/15
70000/70000 [==============================] - 2s - loss: 1.0212 - val_loss: 6.0677
Epoch 8/15
70000/70000 [==============================] - 2s - loss: 1.0214 - val_loss: 5.5073
Epoch 9/15
70000/70000 [==============================] - 2s - loss: 1.0194 - val_loss: 5.0734
Epoch 10/15
70000/70000 [==============================] - 3s - loss: 1.0211 - val_loss: 4.6668
Epoch 11/15
70000/70000 [==============================] - 2s - loss: 1.0185 - val_loss: 4.8204
Epoch 12/15
70000/70000 [==============================] - 2s - loss: 1.0183 - val_loss: 4.5225
Epoch 13/15
70000/70000 [==============================] - 2s - loss: 1.0195 - val_loss: 4.8269
Epoch 14/15
70000/70000 [==============================] - 2s - loss: 1.0196 - val_loss: 4.7607
Epoch 15/15
70000/70000 [==============================] - 2s - loss: 1.0196 - val_loss: 4.2425
</pre>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">plot</span><span class="pgcssp">(</span><span class="pgcssn">history</span><span class="pgcsso">.</span><span class="pgcssn">history</span><span class="pgcssp">[</span><span class="pgcsss">&quot;val_loss&quot;</span><span class="pgcssp">])</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">show</span><span class="pgcssp">()</span>
</pre></div>
</td></tr></table><img alt="" src="../../images/nnpart1_files/nnpart1_13_0.png" />
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="pgcssn">predictions_oos</span> <span class="pgcsso">=</span> <span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">predict</span><span class="pgcssp">({</span><span class="pgcsss">&#39;exog&#39;</span><span class="pgcssp">:</span> <span class="pgcssn">time</span><span class="pgcssp">[</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">:,</span><span class="pgcssbp">None</span><span class="pgcssp">]},</span> <span class="pgcssn">batch_size</span><span class="pgcsso">=</span><span class="pgcssmi">128</span><span class="pgcssp">)</span>
<span class="pgcssn">predictions_is</span> <span class="pgcsso">=</span> <span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">predict</span><span class="pgcssp">({</span><span class="pgcsss">&#39;exog&#39;</span><span class="pgcssp">:</span> <span class="pgcssn">time</span><span class="pgcssp">[:</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">,</span><span class="pgcssbp">None</span><span class="pgcssp">]},</span> <span class="pgcssn">batch_size</span><span class="pgcsso">=</span><span class="pgcssmi">128</span><span class="pgcssp">)</span>
<span class="pgcssn">predictionsg_oos</span> <span class="pgcsso">=</span> <span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">concatenate</span><span class="pgcssp">([</span><span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">array</span><span class="pgcssp">([</span><span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">nan</span> <span class="pgcssk">for</span> <span class="pgcssn">el</span> <span class="pgcssow">in</span> <span class="pgcssnb">range</span><span class="pgcssp">(</span><span class="pgcssmi">70000</span><span class="pgcssp">)]),</span> <span class="pgcssn">predictions_oos</span><span class="pgcssp">[</span><span class="pgcsss">&quot;output&quot;</span><span class="pgcssp">]</span><span class="pgcsso">.</span><span class="pgcssn">flatten</span><span class="pgcssp">()])</span>
<span class="pgcssn">predictionsg_is</span> <span class="pgcsso">=</span> <span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">concatenate</span><span class="pgcssp">([</span><span class="pgcssn">predictions_is</span><span class="pgcssp">[</span><span class="pgcsss">&quot;output&quot;</span><span class="pgcssp">]</span><span class="pgcsso">.</span><span class="pgcssn">flatten</span><span class="pgcssp">(),</span> <span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">array</span><span class="pgcssp">([</span><span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">nan</span> <span class="pgcssk">for</span> <span class="pgcssn">el</span> <span class="pgcssow">in</span> <span class="pgcssnb">range</span><span class="pgcssp">(</span><span class="pgcssmi">30000</span><span class="pgcssp">)])])</span>

<span class="pgcssn">fig</span> <span class="pgcsso">=</span> <span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">figure</span><span class="pgcssp">(</span><span class="pgcssn">figsize</span><span class="pgcsso">=</span><span class="pgcssp">(</span><span class="pgcssmi">12</span><span class="pgcssp">,</span><span class="pgcssmi">8</span><span class="pgcssp">))</span>
<span class="pgcssk">print</span><span class="pgcssp">(</span><span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">sqrt</span><span class="pgcssp">((</span><span class="pgcssn">predictions_oos</span><span class="pgcssp">[</span><span class="pgcsss">&quot;output&quot;</span><span class="pgcssp">]</span><span class="pgcsso">.</span><span class="pgcssn">flatten</span><span class="pgcssp">()</span><span class="pgcsso">-</span><span class="pgcssn">y_t</span><span class="pgcssp">[</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">:])</span><span class="pgcsso">**</span><span class="pgcssmi">2</span><span class="pgcssp">)</span><span class="pgcsso">.</span><span class="pgcssn">mean</span><span class="pgcssp">())</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">plot</span><span class="pgcssp">(</span><span class="pgcssn">predictionsg_oos</span><span class="pgcssp">,</span> <span class="pgcssn">color</span><span class="pgcsso">=</span><span class="pgcsss">&quot;green&quot;</span><span class="pgcssp">,</span> <span class="pgcssn">dashes</span><span class="pgcsso">=</span><span class="pgcssp">[</span><span class="pgcssmi">8</span><span class="pgcssp">,</span><span class="pgcssmi">2</span><span class="pgcssp">],</span> <span class="pgcssn">linewidth</span><span class="pgcsso">=</span><span class="pgcssmi">2</span><span class="pgcssp">,</span> <span class="pgcssn">label</span><span class="pgcsso">=</span><span class="pgcsss">&quot;Out of sample predictions&quot;</span><span class="pgcssp">)</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">plot</span><span class="pgcssp">(</span><span class="pgcssn">predictionsg_is</span><span class="pgcssp">,</span> <span class="pgcssn">color</span><span class="pgcsso">=</span><span class="pgcsss">&quot;green&quot;</span><span class="pgcssp">,</span> <span class="pgcssn">alpha</span><span class="pgcsso">=</span><span class="pgcssmf">0.8</span><span class="pgcssp">,</span> <span class="pgcssn">linewidth</span><span class="pgcsso">=</span><span class="pgcssmi">2</span><span class="pgcssp">,</span> <span class="pgcssn">label</span><span class="pgcsso">=</span><span class="pgcsss">&quot;In sample predictions&quot;</span><span class="pgcssp">)</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">plot</span><span class="pgcssp">(</span><span class="pgcssn">y_t</span><span class="pgcssp">,</span> <span class="pgcssn">alpha</span><span class="pgcsso">=</span><span class="pgcssmf">0.6</span><span class="pgcssp">,</span> <span class="pgcssn">label</span><span class="pgcsso">=</span><span class="pgcsss">&quot;Original Series&quot;</span><span class="pgcssp">)</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">legend</span><span class="pgcssp">()</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">show</span><span class="pgcssp">()</span>
</pre></div>
</td></tr></table><pre class="literal-block">
1.06712052617
</pre>
<img alt="" src="../../images/nnpart1_files/nnpart1_14_1.png" />
<p>We can fit the trend in the training set but the validation performance
is not crazy. Let's add some regularization on the parameters of the
last layer. We choose a L1 regularization to have a sparse structure in
the model. TODO REF</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="pgcsskn">from</span> <span class="pgcssnn">keras.regularizers</span> <span class="pgcsskn">import</span> <span class="pgcssn">l1l2</span><span class="pgcssp">,</span> <span class="pgcssn">l1</span>

<span class="pgcssn">model</span> <span class="pgcsso">=</span> <span class="pgcssn">Graph</span><span class="pgcssp">()</span>
<span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">add_input</span><span class="pgcssp">(</span><span class="pgcssn">name</span><span class="pgcsso">=</span><span class="pgcsss">&#39;exog&#39;</span><span class="pgcssp">,</span> <span class="pgcssn">input_shape</span><span class="pgcsso">=</span><span class="pgcssp">(</span><span class="pgcssmi">1</span><span class="pgcssp">,))</span>
<span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">add_node</span><span class="pgcssp">(</span><span class="pgcssn">Dense</span><span class="pgcssp">(</span><span class="pgcssmi">10</span><span class="pgcssp">,</span> <span class="pgcssn">activation</span><span class="pgcsso">=</span><span class="pgcsss">&quot;sigmoid&quot;</span><span class="pgcssp">,</span> <span class="pgcssn">W_regularizer</span><span class="pgcsso">=</span><span class="pgcssn">l1</span><span class="pgcssp">(</span><span class="pgcssmf">0.1</span><span class="pgcssp">)),</span> <span class="pgcssn">name</span><span class="pgcsso">=</span><span class="pgcsss">&#39;dense1&#39;</span><span class="pgcssp">,</span> <span class="pgcssnb">input</span><span class="pgcsso">=</span><span class="pgcsss">&#39;exog&#39;</span><span class="pgcssp">)</span>
<span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">add_node</span><span class="pgcssp">(</span><span class="pgcssn">Dense</span><span class="pgcssp">(</span><span class="pgcssmi">1</span><span class="pgcssp">,</span> <span class="pgcssn">activation</span><span class="pgcsso">=</span><span class="pgcsss">&quot;linear&quot;</span><span class="pgcssp">),</span> <span class="pgcssn">name</span><span class="pgcsso">=</span><span class="pgcsss">&#39;last_dense&#39;</span><span class="pgcssp">,</span> <span class="pgcssnb">input</span><span class="pgcsso">=</span><span class="pgcsss">&#39;dense1&#39;</span><span class="pgcssp">)</span>
<span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">add_output</span><span class="pgcssp">(</span><span class="pgcssn">name</span><span class="pgcsso">=</span><span class="pgcsss">&#39;output&#39;</span><span class="pgcssp">,</span> <span class="pgcssnb">input</span><span class="pgcsso">=</span><span class="pgcsss">&#39;last_dense&#39;</span><span class="pgcssp">)</span>
<span class="pgcssn">adam</span> <span class="pgcsso">=</span> <span class="pgcssn">Adam</span><span class="pgcssp">(</span><span class="pgcssn">lr</span><span class="pgcsso">=</span><span class="pgcssmf">1e-2</span><span class="pgcssp">,</span> <span class="pgcssn">beta_1</span><span class="pgcsso">=</span><span class="pgcssmf">0.9</span><span class="pgcssp">,</span> <span class="pgcssn">beta_2</span><span class="pgcsso">=</span><span class="pgcssmf">0.999</span><span class="pgcssp">,</span> <span class="pgcssn">epsilon</span><span class="pgcsso">=</span><span class="pgcssmf">1e-8</span><span class="pgcssp">)</span>

<span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">compile</span><span class="pgcssp">(</span><span class="pgcssn">optimizer</span><span class="pgcsso">=</span><span class="pgcssn">adam</span><span class="pgcssp">,</span> <span class="pgcssn">loss</span><span class="pgcsso">=</span><span class="pgcssp">{</span><span class="pgcsss">&#39;output&#39;</span><span class="pgcssp">:</span><span class="pgcsss">&#39;mse&#39;</span><span class="pgcssp">})</span>
</pre></div>
</td></tr></table><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="pgcssn">history</span> <span class="pgcsso">=</span> <span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">fit</span><span class="pgcssp">({</span><span class="pgcsss">&#39;exog&#39;</span><span class="pgcssp">:</span> <span class="pgcssn">time</span><span class="pgcssp">[:</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">,</span><span class="pgcssbp">None</span><span class="pgcssp">],</span> <span class="pgcsss">&#39;output&#39;</span><span class="pgcssp">:</span> <span class="pgcssn">y_t</span><span class="pgcssp">[:</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">]},</span>
          <span class="pgcssn">validation_data</span><span class="pgcsso">=</span><span class="pgcssp">{</span><span class="pgcsss">&#39;exog&#39;</span><span class="pgcssp">:</span><span class="pgcssn">time</span><span class="pgcssp">[</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">:,</span> <span class="pgcssbp">None</span><span class="pgcssp">],</span> <span class="pgcsss">&#39;output&#39;</span><span class="pgcssp">:</span> <span class="pgcssn">y_t</span><span class="pgcssp">[</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">:]},</span>
          <span class="pgcssn">batch_size</span><span class="pgcsso">=</span><span class="pgcssmi">32</span><span class="pgcssp">,</span>
          <span class="pgcssn">nb_epoch</span><span class="pgcsso">=</span><span class="pgcssmi">15</span><span class="pgcssp">)</span>
</pre></div>
</td></tr></table><pre class="literal-block">
Train on 70000 samples, validate on 30000 samples
Epoch 1/15
70000/70000 [==============================] - 3s - loss: 136.6215 - val_loss: 22.1850
Epoch 2/15
70000/70000 [==============================] - 3s - loss: 1.5800 - val_loss: 14.3134
Epoch 3/15
70000/70000 [==============================] - 3s - loss: 1.3127 - val_loss: 10.4879
Epoch 4/15
70000/70000 [==============================] - 3s - loss: 1.2291 - val_loss: 8.1836
Epoch 5/15
70000/70000 [==============================] - 3s - loss: 1.1846 - val_loss: 4.8606
Epoch 6/15
70000/70000 [==============================] - 3s - loss: 1.1621 - val_loss: 3.3897
Epoch 7/15
70000/70000 [==============================] - 3s - loss: 1.1507 - val_loss: 2.6652
Epoch 8/15
70000/70000 [==============================] - 3s - loss: 1.1454 - val_loss: 2.1846
Epoch 9/15
70000/70000 [==============================] - 3s - loss: 1.1367 - val_loss: 2.0425
Epoch 10/15
70000/70000 [==============================] - 3s - loss: 1.1325 - val_loss: 2.0950
Epoch 11/15
70000/70000 [==============================] - 3s - loss: 1.1299 - val_loss: 2.2542
Epoch 12/15
70000/70000 [==============================] - 3s - loss: 1.1272 - val_loss: 2.5774
Epoch 13/15
70000/70000 [==============================] - 3s - loss: 1.1257 - val_loss: 1.9371
Epoch 14/15
70000/70000 [==============================] - 3s - loss: 1.1252 - val_loss: 1.6037
Epoch 15/15
70000/70000 [==============================] - 3s - loss: 1.1203 - val_loss: 1.7094
</pre>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">plot</span><span class="pgcssp">(</span><span class="pgcssn">history</span><span class="pgcsso">.</span><span class="pgcssn">history</span><span class="pgcssp">[</span><span class="pgcsss">&quot;val_loss&quot;</span><span class="pgcssp">])</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">show</span><span class="pgcssp">()</span>
</pre></div>
</td></tr></table><img alt="" src="../../images/nnpart1_files/nnpart1_18_0.png" />
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="pgcssn">predictions_oos</span> <span class="pgcsso">=</span> <span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">predict</span><span class="pgcssp">({</span><span class="pgcsss">&#39;exog&#39;</span><span class="pgcssp">:</span> <span class="pgcssn">time</span><span class="pgcssp">[</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">:,</span><span class="pgcssbp">None</span><span class="pgcssp">]},</span> <span class="pgcssn">batch_size</span><span class="pgcsso">=</span><span class="pgcssmi">128</span><span class="pgcssp">)</span>
<span class="pgcssn">predictions_is</span> <span class="pgcsso">=</span> <span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">predict</span><span class="pgcssp">({</span><span class="pgcsss">&#39;exog&#39;</span><span class="pgcssp">:</span> <span class="pgcssn">time</span><span class="pgcssp">[:</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">,</span><span class="pgcssbp">None</span><span class="pgcssp">]},</span> <span class="pgcssn">batch_size</span><span class="pgcsso">=</span><span class="pgcssmi">128</span><span class="pgcssp">)</span>
<span class="pgcssn">predictionsg_oos</span> <span class="pgcsso">=</span> <span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">concatenate</span><span class="pgcssp">([</span><span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">array</span><span class="pgcssp">([</span><span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">nan</span> <span class="pgcssk">for</span> <span class="pgcssn">el</span> <span class="pgcssow">in</span> <span class="pgcssnb">range</span><span class="pgcssp">(</span><span class="pgcssmi">70000</span><span class="pgcssp">)]),</span> <span class="pgcssn">predictions_oos</span><span class="pgcssp">[</span><span class="pgcsss">&quot;output&quot;</span><span class="pgcssp">]</span><span class="pgcsso">.</span><span class="pgcssn">flatten</span><span class="pgcssp">()])</span>
<span class="pgcssn">predictionsg_is</span> <span class="pgcsso">=</span> <span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">concatenate</span><span class="pgcssp">([</span><span class="pgcssn">predictions_is</span><span class="pgcssp">[</span><span class="pgcsss">&quot;output&quot;</span><span class="pgcssp">]</span><span class="pgcsso">.</span><span class="pgcssn">flatten</span><span class="pgcssp">(),</span> <span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">array</span><span class="pgcssp">([</span><span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">nan</span> <span class="pgcssk">for</span> <span class="pgcssn">el</span> <span class="pgcssow">in</span> <span class="pgcssnb">range</span><span class="pgcssp">(</span><span class="pgcssmi">30000</span><span class="pgcssp">)])])</span>

<span class="pgcssn">fig</span> <span class="pgcsso">=</span> <span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">figure</span><span class="pgcssp">(</span><span class="pgcssn">figsize</span><span class="pgcsso">=</span><span class="pgcssp">(</span><span class="pgcssmi">12</span><span class="pgcssp">,</span><span class="pgcssmi">8</span><span class="pgcssp">))</span>
<span class="pgcssk">print</span><span class="pgcssp">(</span><span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">sqrt</span><span class="pgcssp">((</span><span class="pgcssn">predictions_oos</span><span class="pgcssp">[</span><span class="pgcsss">&quot;output&quot;</span><span class="pgcssp">]</span><span class="pgcsso">.</span><span class="pgcssn">flatten</span><span class="pgcssp">()</span><span class="pgcsso">-</span><span class="pgcssn">y_t</span><span class="pgcssp">[</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">:])</span><span class="pgcsso">**</span><span class="pgcssmi">2</span><span class="pgcssp">)</span><span class="pgcsso">.</span><span class="pgcssn">mean</span><span class="pgcssp">())</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">plot</span><span class="pgcssp">(</span><span class="pgcssn">predictionsg_oos</span><span class="pgcssp">,</span> <span class="pgcssn">color</span><span class="pgcsso">=</span><span class="pgcsss">&quot;green&quot;</span><span class="pgcssp">,</span> <span class="pgcssn">dashes</span><span class="pgcsso">=</span><span class="pgcssp">[</span><span class="pgcssmi">8</span><span class="pgcssp">,</span><span class="pgcssmi">2</span><span class="pgcssp">],</span> <span class="pgcssn">linewidth</span><span class="pgcsso">=</span><span class="pgcssmi">2</span><span class="pgcssp">,</span> <span class="pgcssn">label</span><span class="pgcsso">=</span><span class="pgcsss">&quot;Out of sample predictions&quot;</span><span class="pgcssp">)</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">plot</span><span class="pgcssp">(</span><span class="pgcssn">predictionsg_is</span><span class="pgcssp">,</span> <span class="pgcssn">color</span><span class="pgcsso">=</span><span class="pgcsss">&quot;green&quot;</span><span class="pgcssp">,</span> <span class="pgcssn">alpha</span><span class="pgcsso">=</span><span class="pgcssmf">0.8</span><span class="pgcssp">,</span> <span class="pgcssn">linewidth</span><span class="pgcsso">=</span><span class="pgcssmi">2</span><span class="pgcssp">,</span> <span class="pgcssn">label</span><span class="pgcsso">=</span><span class="pgcsss">&quot;In sample predictions&quot;</span><span class="pgcssp">)</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">plot</span><span class="pgcssp">(</span><span class="pgcssn">y_t</span><span class="pgcssp">,</span> <span class="pgcssn">alpha</span><span class="pgcsso">=</span><span class="pgcssmf">0.6</span><span class="pgcssp">,</span> <span class="pgcssn">label</span><span class="pgcsso">=</span><span class="pgcsss">&quot;Original Series&quot;</span><span class="pgcssp">)</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">legend</span><span class="pgcssp">()</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">show</span><span class="pgcssp">()</span>
</pre></div>
</td></tr></table><pre class="literal-block">
1.06712052617
</pre>
<img alt="" src="../../images/nnpart1_files/nnpart1_19_1.png" />
<p>It seems reasonnable to add some regularization since we capture the
quadratic trend with more accuracy.</p>
<div class="section" id="using-an-ar-structure-for-one-step-ahead-predictions">
<h3>Using an AR structure for one step ahead predictions</h3>
<p>Because we have seasonnality in our data we could try to use lags of the
time series to capture the recurrent patterns we see.</p>
<p>To do so, we crop some patches out of our time series.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="pgcsskn">from</span> <span class="pgcssnn">sklearn.feature_extraction.image</span> <span class="pgcsskn">import</span> <span class="pgcssn">extract_patches_2d</span>

<span class="pgcssn">len_ts_y</span> <span class="pgcsso">=</span> <span class="pgcssmi">60</span>

<span class="pgcssn">data_patched</span> <span class="pgcsso">=</span> <span class="pgcssn">extract_patches_2d</span><span class="pgcssp">(</span><span class="pgcssn">y_t</span><span class="pgcssp">[:,</span><span class="pgcssbp">None</span><span class="pgcssp">],</span> <span class="pgcssp">(</span><span class="pgcssn">len_ts_y</span><span class="pgcssp">,</span><span class="pgcssmi">1</span><span class="pgcssp">))</span>
<span class="pgcssn">y_train</span> <span class="pgcsso">=</span> <span class="pgcssn">data_patched</span><span class="pgcssp">[:,</span><span class="pgcsso">-</span><span class="pgcssmi">1</span><span class="pgcssp">,</span><span class="pgcsso">-</span><span class="pgcssmi">1</span><span class="pgcssp">]</span>
<span class="pgcssn">endog_train</span> <span class="pgcsso">=</span> <span class="pgcssn">data_patched</span><span class="pgcssp">[:,</span><span class="pgcsso">-</span><span class="pgcssn">len_ts_y</span><span class="pgcsso">-</span><span class="pgcssmi">1</span><span class="pgcssp">:</span><span class="pgcsso">-</span><span class="pgcssmi">1</span><span class="pgcssp">,</span><span class="pgcsso">-</span><span class="pgcssmi">1</span><span class="pgcssp">]</span>
</pre></div>
</td></tr></table><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="pgcssn">endog_train</span><span class="pgcsso">.</span><span class="pgcssn">shape</span>
</pre></div>
</td></tr></table><pre class="literal-block">
(99941, 59)
</pre>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="pgcssn">endog_train</span> <span class="pgcsso">=</span> <span class="pgcssp">(</span><span class="pgcssn">endog_train</span><span class="pgcsso">-</span><span class="pgcssn">endog_train</span><span class="pgcsso">.</span><span class="pgcssn">mean</span><span class="pgcssp">(</span><span class="pgcssn">axis</span><span class="pgcsso">=</span><span class="pgcssmi">0</span><span class="pgcssp">))</span><span class="pgcsso">/</span><span class="pgcssn">endog_train</span><span class="pgcsso">.</span><span class="pgcssn">std</span><span class="pgcssp">(</span><span class="pgcssn">axis</span><span class="pgcsso">=</span><span class="pgcssmi">0</span><span class="pgcssp">)</span>
</pre></div>
</td></tr></table><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="pgcssn">model</span> <span class="pgcsso">=</span> <span class="pgcssn">Graph</span><span class="pgcssp">()</span>
<span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">add_input</span><span class="pgcssp">(</span><span class="pgcssn">name</span><span class="pgcsso">=</span><span class="pgcsss">&#39;endog&#39;</span><span class="pgcssp">,</span> <span class="pgcssn">input_shape</span><span class="pgcsso">=</span><span class="pgcssp">(</span><span class="pgcssmi">59</span><span class="pgcssp">,))</span>
<span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">add_node</span><span class="pgcssp">(</span><span class="pgcssn">Dense</span><span class="pgcssp">(</span><span class="pgcssmi">10</span><span class="pgcssp">,</span> <span class="pgcssn">activation</span><span class="pgcsso">=</span><span class="pgcsss">&quot;sigmoid&quot;</span><span class="pgcssp">),</span> <span class="pgcssn">name</span><span class="pgcsso">=</span><span class="pgcsss">&#39;dense1&#39;</span><span class="pgcssp">,</span> <span class="pgcssnb">input</span><span class="pgcsso">=</span><span class="pgcsss">&#39;exog&#39;</span><span class="pgcssp">)</span>
<span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">add_node</span><span class="pgcssp">(</span><span class="pgcssn">Dense</span><span class="pgcssp">(</span><span class="pgcssmi">1</span><span class="pgcssp">,</span> <span class="pgcssn">activation</span><span class="pgcsso">=</span><span class="pgcsss">&quot;linear&quot;</span><span class="pgcssp">),</span> <span class="pgcssn">name</span><span class="pgcsso">=</span><span class="pgcsss">&#39;last_dense&#39;</span><span class="pgcssp">,</span> <span class="pgcssnb">input</span><span class="pgcsso">=</span><span class="pgcsss">&#39;dense1&#39;</span><span class="pgcssp">)</span>
<span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">add_output</span><span class="pgcssp">(</span><span class="pgcssn">name</span><span class="pgcsso">=</span><span class="pgcsss">&#39;output&#39;</span><span class="pgcssp">,</span> <span class="pgcssnb">input</span><span class="pgcsso">=</span><span class="pgcsss">&#39;last_dense&#39;</span><span class="pgcssp">)</span>
<span class="pgcssn">adam</span> <span class="pgcsso">=</span> <span class="pgcssn">Adam</span><span class="pgcssp">(</span><span class="pgcssn">lr</span><span class="pgcsso">=</span><span class="pgcssmf">1e-3</span><span class="pgcssp">,</span> <span class="pgcssn">beta_1</span><span class="pgcsso">=</span><span class="pgcssmf">0.9</span><span class="pgcssp">,</span> <span class="pgcssn">beta_2</span><span class="pgcsso">=</span><span class="pgcssmf">0.999</span><span class="pgcssp">,</span> <span class="pgcssn">epsilon</span><span class="pgcsso">=</span><span class="pgcssmf">1e-8</span><span class="pgcssp">)</span>

<span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">compile</span><span class="pgcssp">(</span><span class="pgcssn">optimizer</span><span class="pgcsso">=</span><span class="pgcssn">adam</span><span class="pgcssp">,</span> <span class="pgcssn">loss</span><span class="pgcsso">=</span><span class="pgcssp">{</span><span class="pgcsss">&#39;output&#39;</span><span class="pgcssp">:</span><span class="pgcsss">&#39;mse&#39;</span><span class="pgcssp">})</span>
</pre></div>
</td></tr></table><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="pgcssn">history</span> <span class="pgcsso">=</span> <span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">fit</span><span class="pgcssp">({</span><span class="pgcsss">&#39;endog&#39;</span><span class="pgcssp">:</span> <span class="pgcssn">endog_train</span><span class="pgcssp">[:</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">]</span><span class="pgcsso">.</span><span class="pgcssn">reshape</span><span class="pgcssp">(</span><span class="pgcsso">-</span><span class="pgcssmi">1</span><span class="pgcssp">,</span><span class="pgcssmi">59</span><span class="pgcssp">),</span> <span class="pgcsss">&#39;output&#39;</span><span class="pgcssp">:</span> <span class="pgcssn">y_t</span><span class="pgcssp">[:</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">]},</span>
          <span class="pgcssn">validation_data</span><span class="pgcsso">=</span><span class="pgcssp">{</span><span class="pgcsss">&#39;endog&#39;</span><span class="pgcssp">:</span><span class="pgcssn">endog_train</span><span class="pgcssp">[</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">:]</span><span class="pgcsso">.</span><span class="pgcssn">reshape</span><span class="pgcssp">(</span><span class="pgcsso">-</span><span class="pgcssmi">1</span><span class="pgcssp">,</span><span class="pgcssmi">59</span><span class="pgcssp">),</span> <span class="pgcsss">&#39;output&#39;</span><span class="pgcssp">:</span> <span class="pgcssn">y_t</span><span class="pgcssp">[</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">:]},</span>
          <span class="pgcssn">batch_size</span><span class="pgcsso">=</span><span class="pgcssmi">32</span><span class="pgcssp">,</span>
          <span class="pgcssn">nb_epoch</span><span class="pgcsso">=</span><span class="pgcssmi">15</span><span class="pgcssp">)</span>
</pre></div>
</td></tr></table><pre class="literal-block">
Train on 69941 samples, validate on 30000 samples
Epoch 1/15
69941/69941 [==============================] - 3s - loss: 982.9619 - val_loss: 1247.8897
Epoch 2/15
69941/69941 [==============================] - 3s - loss: 145.4111 - val_loss: 191.2051
Epoch 3/15
69941/69941 [==============================] - 3s - loss: 6.9168 - val_loss: 24.1287
Epoch 4/15
69941/69941 [==============================] - 3s - loss: 0.5594 - val_loss: 17.7060
Epoch 5/15
69941/69941 [==============================] - 3s - loss: 0.4401 - val_loss: 15.0404
Epoch 6/15
69941/69941 [==============================] - 3s - loss: 0.2117 - val_loss: 10.1495
Epoch 7/15
69941/69941 [==============================] - 3s - loss: 0.0487 - val_loss: 5.9489
Epoch 8/15
69941/69941 [==============================] - 2s - loss: 0.0100 - val_loss: 3.6337
Epoch 9/15
69941/69941 [==============================] - 3s - loss: 0.0040 - val_loss: 2.6690
Epoch 10/15
69941/69941 [==============================] - 3s - loss: 0.0029 - val_loss: 2.2827
Epoch 11/15
69941/69941 [==============================] - 3s - loss: 0.0021 - val_loss: 2.1616
Epoch 12/15
69941/69941 [==============================] - 2s - loss: 0.0011 - val_loss: 1.9064
Epoch 13/15
69941/69941 [==============================] - 3s - loss: 0.0008 - val_loss: 1.6561
Epoch 14/15
69941/69941 [==============================] - 3s - loss: 0.0007 - val_loss: 1.4773
Epoch 15/15
69941/69941 [==============================] - 2s - loss: 0.0005 - val_loss: 1.2757
</pre>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="pgcssn">predictions_oos</span> <span class="pgcsso">=</span> <span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">predict</span><span class="pgcssp">({</span><span class="pgcsss">&#39;exog&#39;</span><span class="pgcssp">:</span> <span class="pgcssn">endog_train</span><span class="pgcssp">[</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">:]</span><span class="pgcsso">.</span><span class="pgcssn">reshape</span><span class="pgcssp">(</span><span class="pgcsso">-</span><span class="pgcssmi">1</span><span class="pgcssp">,</span><span class="pgcssmi">59</span><span class="pgcssp">)},</span> <span class="pgcssn">batch_size</span><span class="pgcsso">=</span><span class="pgcssmi">128</span><span class="pgcssp">)</span>
<span class="pgcssn">predictions_is</span> <span class="pgcsso">=</span> <span class="pgcssn">model</span><span class="pgcsso">.</span><span class="pgcssn">predict</span><span class="pgcssp">({</span><span class="pgcsss">&#39;exog&#39;</span><span class="pgcssp">:</span> <span class="pgcssn">endog_train</span><span class="pgcssp">[:</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">]</span><span class="pgcsso">.</span><span class="pgcssn">reshape</span><span class="pgcssp">(</span><span class="pgcsso">-</span><span class="pgcssmi">1</span><span class="pgcssp">,</span><span class="pgcssmi">59</span><span class="pgcssp">)},</span> <span class="pgcssn">batch_size</span><span class="pgcsso">=</span><span class="pgcssmi">128</span><span class="pgcssp">)</span>
<span class="pgcssn">predictionsg_oos</span> <span class="pgcsso">=</span> <span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">concatenate</span><span class="pgcssp">([</span><span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">array</span><span class="pgcssp">([</span><span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">nan</span> <span class="pgcssk">for</span> <span class="pgcssn">el</span> <span class="pgcssow">in</span> <span class="pgcssnb">range</span><span class="pgcssp">(</span><span class="pgcssmi">70000</span><span class="pgcssp">)]),</span> <span class="pgcssn">predictions_oos</span><span class="pgcssp">[</span><span class="pgcsss">&quot;output&quot;</span><span class="pgcssp">]</span><span class="pgcsso">.</span><span class="pgcssn">flatten</span><span class="pgcssp">()])</span>
<span class="pgcssn">predictionsg_is</span> <span class="pgcsso">=</span> <span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">concatenate</span><span class="pgcssp">([</span><span class="pgcssn">predictions_is</span><span class="pgcssp">[</span><span class="pgcsss">&quot;output&quot;</span><span class="pgcssp">]</span><span class="pgcsso">.</span><span class="pgcssn">flatten</span><span class="pgcssp">(),</span> <span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">array</span><span class="pgcssp">([</span><span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">nan</span> <span class="pgcssk">for</span> <span class="pgcssn">el</span> <span class="pgcssow">in</span> <span class="pgcssnb">range</span><span class="pgcssp">(</span><span class="pgcssmi">30000</span><span class="pgcssp">)])])</span>

<span class="pgcssn">fig</span> <span class="pgcsso">=</span> <span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">figure</span><span class="pgcssp">(</span><span class="pgcssn">figsize</span><span class="pgcsso">=</span><span class="pgcssp">(</span><span class="pgcssmi">12</span><span class="pgcssp">,</span><span class="pgcssmi">8</span><span class="pgcssp">))</span>
<span class="pgcssk">print</span><span class="pgcssp">(</span><span class="pgcssn">np</span><span class="pgcsso">.</span><span class="pgcssn">sqrt</span><span class="pgcssp">((</span><span class="pgcssn">predictions_oos</span><span class="pgcssp">[</span><span class="pgcsss">&quot;output&quot;</span><span class="pgcssp">]</span><span class="pgcsso">.</span><span class="pgcssn">flatten</span><span class="pgcssp">()</span><span class="pgcsso">-</span><span class="pgcssn">y_t</span><span class="pgcssp">[</span><span class="pgcsso">-</span><span class="pgcssmi">30000</span><span class="pgcssp">:])</span><span class="pgcsso">**</span><span class="pgcssmi">2</span><span class="pgcssp">)</span><span class="pgcsso">.</span><span class="pgcssn">mean</span><span class="pgcssp">())</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">plot</span><span class="pgcssp">(</span><span class="pgcssn">predictionsg_oos</span><span class="pgcssp">,</span> <span class="pgcssn">color</span><span class="pgcsso">=</span><span class="pgcsss">&quot;green&quot;</span><span class="pgcssp">,</span> <span class="pgcssn">dashes</span><span class="pgcsso">=</span><span class="pgcssp">[</span><span class="pgcssmi">8</span><span class="pgcssp">,</span><span class="pgcssmi">2</span><span class="pgcssp">],</span> <span class="pgcssn">linewidth</span><span class="pgcsso">=</span><span class="pgcssmi">2</span><span class="pgcssp">,</span> <span class="pgcssn">label</span><span class="pgcsso">=</span><span class="pgcsss">&quot;Out of sample predictions&quot;</span><span class="pgcssp">)</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">plot</span><span class="pgcssp">(</span><span class="pgcssn">predictionsg_is</span><span class="pgcssp">,</span> <span class="pgcssn">color</span><span class="pgcsso">=</span><span class="pgcsss">&quot;green&quot;</span><span class="pgcssp">,</span> <span class="pgcssn">alpha</span><span class="pgcsso">=</span><span class="pgcssmf">0.8</span><span class="pgcssp">,</span> <span class="pgcssn">linewidth</span><span class="pgcsso">=</span><span class="pgcssmi">2</span><span class="pgcssp">,</span> <span class="pgcssn">label</span><span class="pgcsso">=</span><span class="pgcsss">&quot;In sample predictions&quot;</span><span class="pgcssp">)</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">plot</span><span class="pgcssp">(</span><span class="pgcssn">y_t</span><span class="pgcssp">,</span> <span class="pgcssn">alpha</span><span class="pgcsso">=</span><span class="pgcssmf">0.6</span><span class="pgcssp">,</span> <span class="pgcssn">label</span><span class="pgcsso">=</span><span class="pgcsss">&quot;Original Series&quot;</span><span class="pgcssp">)</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">legend</span><span class="pgcssp">()</span>
<span class="pgcssn">plt</span><span class="pgcsso">.</span><span class="pgcssn">show</span><span class="pgcssp">()</span>
</pre></div>
</td></tr></table><pre class="literal-block">
0.818090224748
</pre>
<img alt="" src="../../images/nnpart1_files/nnpart1_29_1.png" />
</div>
</div>
<script type='text/javascript'>if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    var location_protocol = (false) ? 'https' : document.location.protocol;
    if (location_protocol !== 'http' && location_protocol !== 'https') location_protocol = 'https:';
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = location_protocol + '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
            </div>
            <!-- /.entry-content -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'macgython'; // required: replace example with your forum shortname

                    var disqus_identifier = 'neural-nets-with-keras-part-1-time-series';
                var disqus_url = 'http://tboquet.github.io/neural-nets-with-keras-part-1-time-series.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://ca.linkedin.com/in/tboquet"><i class="fa fa-linkedin-profile-square fa-lg"></i> Linkedin Profile</a></li>
                <li class="list-group-item"><a href="https://twitter.com/thomasboquet"><i class="fa fa-twitter-profile-square fa-lg"></i> Twitter Profile</a></li>
              </ul>
            </li>



    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://getpelican.com/" target="_blank">
                Pelican
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://python.org/" target="_blank">
                Python.org
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://jinja.pocoo.org/" target="_blank">
                Jinja2
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2015 Thomas Boquet
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://tboquet.github.io/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://tboquet.github.io/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://tboquet.github.io/theme/js/respond.min.js"></script>

    <script src="http://tboquet.github.io/theme/js/bodypadding.js"></script>
    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'macgython'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-65972554-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

</body>
</html>